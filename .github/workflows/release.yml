name: Release

on:
  release:
    types:
    - published
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true

    - uses: actions/cache@v3
      with:
        path: |
            ~/.gradle/loom-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
        key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
            gradle-

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        java-version: 17
        distribution: 'temurin'

    - name: Build and publish with Gradle
      run: ./gradlew build publish
      env:
        CURSEFORGE: ${{ secrets.CURSEFORGE }}
        MODRINTH: ${{ secrets.MODRINTH }}
        CHANGELOG: ${{ github.event.release.body }}

    - name: Upload GitHub release
      uses: AButler/upload-release-assets@v2.0
      with:
        files: 'build/libs/*.jar;!build/libs/*-sources.jar;!build/libs/*-dev.jar'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
